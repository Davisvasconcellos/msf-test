<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respostas Técnicas - MSF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>

<header id="top-header">
    <div class="container-fluid d-flex align-items-center">
        <img src="https://storage.empregare.com/hotsite/msfvagasbrasil/logo-4d37bea5-ea60-4954-818e-e6c7744507a6.png?CacheVersao=f9b3e029-3359-4c8a-8c81-5bce6f600c35" alt="MSF Logo" style="height: 40px;">
    </div>
</header>

<div id="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar-wrapper">
        <div class="list-group list-group-flush pt-1" id="toc-list">
            <!-- JS vai preencher -->
        </div>
        <div class="pt-2 pb-2 border-top" style="display: flex; flex-direction: column; padding: 15px;">
            <h6 class="text-uppercase text-muted small fw-bold mb-2" style="margin-top: 15px;"><i class="bi bi-play-circle-fill me-2" style="color: #EE0000;"></i>Demos Interativas</h6>
            <div class="d-grid gap-1">
                <a href="/responses" class="btn btn-outline-secondary btn-sm text-start"><i class="bi bi-journal-text me-2"></i>Respostas</a>
                <a href="/demo/1" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-key me-2"></i>OAuth 2.0</a>
                <a href="/demo/5" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-database me-2"></i>SQL Update</a>
                <a href="/demo/6" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-cloud-arrow-down me-2"></i>API Mock</a>
                <a href="/demo/3" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-diagram-3 me-2"></i>CTE Recursiva</a>
                <a href="/demo/7" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-people me-2"></i>Normalização</a>
                <a href="/demo/8" class="btn btn-outline-danger btn-sm text-start"><i class="bi bi-diagram-3-fill me-2"></i>Deep Key Map</a>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
<div style="display:contents" dir="auto"><p id="308795ef-9f12-8026-8cec-e50e4d8960b4" class="">
  
    <div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80d5-bd44-fb83d619a7b2" class="">  <strong>Pergunta 1:</strong>  Explique detalhadamente como funciona o fluxo de autorização em uma API que utiliza OAuth 2.0 com tokens JWT. Inclua em sua resposta:</h3></div>
 <div style="display:contents" dir="auto"><ul id="308795ef-9f12-8012-a0ac-fa1d10411506" class="bulleted-list"><li style="list-style-type:disc">Diferença entre Access Token e Refresh Token.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80da-971e-d96b0700f389" class="bulleted-list"><li style="list-style-type:disc">Como o servidor valida a autenticidade e integridade do token.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80bb-ad39-edcb7ab0cbdd" class="bulleted-list"><li style="list-style-type:disc">Quais riscos de segurança podem surgir se o token não for devidamente protegido.</li></ul></div><div style="display:contents" dir="auto">
 
    <p id="308795ef-9f12-80d1-bcfc-dde3ecbe2ae0" class="">O fluxo de autorização mais recomendado e seguro para aplicações web e mobile que utilizam OAuth 2.0 com tokens JWT é o <strong>Authorization Code Flow com PKCE</strong> (Proof Key for Code Exchange), conforme as melhores práticas atuais (OAuth 2.1 draft e RFC 8252). Ele é adequado tanto para clientes confidenciais (com client_secret) quanto públicos (SPAs, apps mobile).</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80ff-b856-c23430862089" class=""><strong>Fluxo detalhado (Authorization Code Flow + PKCE):</strong></p></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-808d-99ba-fa5b4d031722" class="numbered-list" start="1"><li>O cliente redireciona o usuário para o endpoint /authorize do Authorization Server com:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-808a-8f5f-c753cf520994" class="bulleted-list"><li style="list-style-type:disc">client_id</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e7-886a-c6b094f4a53f" class="bulleted-list"><li style="list-style-type:disc">redirect_uri</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b7-ada7-c267db7a971d" class="bulleted-list"><li style="list-style-type:disc">scope (ex.: openid profile email)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-803c-88c0-d2ec2f37a6f8" class="bulleted-list"><li style="list-style-type:disc">response_type=code</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-809d-a579-de9e8bd4a0b1" class="bulleted-list"><li style="list-style-type:disc">state (para proteção contra CSRF)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8067-ae41-d4e06ad3bd90" class="bulleted-list"><li style="list-style-type:disc">code_challenge (SHA-256 do code_verifier – obrigatório com PKCE)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-802c-8e53-dc7487c58264" class="bulleted-list"><li style="list-style-type:disc">code_challenge_method=S256</li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80f8-9011-f937b6e63212" class="numbered-list" start="2"><li>O usuário autentica-se e concede consentimento no Authorization Server.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-808d-88a7-c5e964deb45c" class="numbered-list" start="3"><li>O Authorization Server redireciona de volta para o redirect_uri com um authorization_code (código de uso único, curto prazo e vinculado ao PKCE).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80f1-9184-c8b1c7f6cd72" class="numbered-list" start="4"><li>O cliente realiza uma requisição <strong>POST</strong> para o endpoint /token:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ce-9e07-e5560723b9c2" class="bulleted-list"><li style="list-style-type:disc">grant_type=authorization_code</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8050-adb9-c8309205c6ce" class="bulleted-list"><li style="list-style-type:disc">code</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d4-aa34-d0d3497db866" class="bulleted-list"><li style="list-style-type:disc">redirect_uri</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-804a-8c76-cbada02743d6" class="bulleted-list"><li style="list-style-type:disc">client_id (e client_secret se cliente confidencial)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8003-b0bc-e0ac896c8a25" class="bulleted-list"><li style="list-style-type:disc">code_verifier (para validar o PKCE)</li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80b2-918f-f36d08f4c4a4" class="numbered-list" start="5"><li>O Authorization Server valida todos os parâmetros e retorna:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d2-b518-fe0b0876eba3" class="bulleted-list"><li style="list-style-type:disc">access_token (geralmente JWT, mas pode ser opaco)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80df-9d8f-e6a55d1ac43b" class="bulleted-list"><li style="list-style-type:disc">token_type=Bearer</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-804e-a068-f2fab823bc61" class="bulleted-list"><li style="list-style-type:disc">expires_in (ex.: 3600 segundos)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d1-afd0-cc180b3b4c7e" class="bulleted-list"><li style="list-style-type:disc">refresh_token (opcional, mas recomendado para sessões longas)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ce-ae6f-cb7443c8cfb8" class="bulleted-list"><li style="list-style-type:disc">id_token (se OpenID Connect estiver em uso)</li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80ac-aace-e31fe1ff00d2" class="numbered-list" start="6"><li>O cliente inclui o access_token em requisições à API protegida:<div style="display:contents" dir="auto"><p id="308795ef-9f12-80ab-8f67-f3018032d834" class="">text</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-808e-9572-ca659a9cc396" class=""><code>Authorization: Bearer eyJhbGciOiJSUzI1NiIs...</code></p></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80a2-8d58-f2f553f2e0fe" class="numbered-list" start="7"><li>Quando o access token expira, o cliente envia o refresh_token para /token com grant_type=refresh_token (e client_id/client_secret se aplicável), obtendo um novo access token (e possivelmente novo refresh token, se rotation estiver implementada).</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8089-93ce-d5fbca875c11" class=""><strong>Diferença entre Access Token e Refresh Token:</strong></p></div><div style="display:contents" dir="ltr"><table id="308795ef-9f12-80bd-805f-f05fb90464ce" class="simple-table"><thead class="simple-table-header"><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-807f-893f-ffd4e2451b16"><th id="^UAO" class="simple-table-header-color simple-table-header">Aspecto</th><th id="EkD&lt;" class="simple-table-header-color simple-table-header">Access Token</th><th id="WQ:S" class="simple-table-header-color simple-table-header">Refresh Token</th></tr></div></thead><tbody><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8008-8dfe-de5eda622c71"><td id="^UAO" class="">Propósito</td><td id="EkD&lt;" class="">Acessar recursos da API</td><td id="WQ:S" class="">Obter novo access token sem reautenticação</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80ef-b486-ca3a13ce1264"><td id="^UAO" class="">Duração típica</td><td id="EkD&lt;" class="">Curta (5–60 minutos)</td><td id="WQ:S" class="">Longa (dias, semanas ou indefinida)</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8082-bd7a-d95ba1178b7a"><td id="^UAO" class="">Formato</td><td id="EkD&lt;" class="">Geralmente JWT (self-contained), mas pode ser opaco (string aleatória)</td><td id="WQ:S" class="">Geralmente opaco (string aleatória), pode ser JWT</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80fa-95a2-d09384ed2928"><td id="^UAO" class="">Armazenamento seguro</td><td id="EkD&lt;" class="">Memória segura / HttpOnly cookie (web)</td><td id="WQ:S" class="">HttpOnly + Secure cookie / backend seguro</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80e2-ad5f-d118f79dff23"><td id="^UAO" class="">Validação</td><td id="EkD&lt;" class="">Resource Server (localmente para JWT; introspection para opaco)</td><td id="WQ:S" class="">Apenas Authorization Server</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80c9-a93c-e1f1aa437897"><td id="^UAO" class="">Escopo</td><td id="EkD&lt;" class="">Contém claims (sub, scopes, exp, aud, iss)</td><td id="WQ:S" class="">Não contém scopes de acesso</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8060-a35f-dec0f8a2459b"><td id="^UAO" class="">Revogação</td><td id="EkD&lt;" class="">Não trivial em modelo stateless (expiração curta, blacklist via jti, introspection)</td><td id="WQ:S" class="">Fácil (revogação direta no Authorization Server)</td></tr></div></tbody></table></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80ad-a679-eeea95f172b3" class=""><strong>Como o servidor (Resource Server) valida a autenticidade e integridade do token JWT:</strong></p></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8028-9be9-e82c4e70a3bb" class="numbered-list" start="1"><li><strong>Verifica a assinatura</strong><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8060-bdb4-cff919488e39" class="bulleted-list"><li style="list-style-type:disc">Obtém a chave pública do issuer via JWKS endpoint (/.well-known/jwks.json)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80a1-9931-ef9b6307c9e8" class="bulleted-list"><li style="list-style-type:disc">Usa algoritmo declarado no header (ex.: RS256 – RSA + SHA-256)</li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80a2-95f8-ecde97669b26" class="numbered-list" start="2"><li><strong>Valida os claims obrigatórios</strong><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d1-8517-ca0c496efbe9" class="bulleted-list"><li style="list-style-type:disc">iss (issuer): deve corresponder ao issuer confiável</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-800a-81f6-fab3379eae46" class="bulleted-list"><li style="list-style-type:disc">aud (audience): deve incluir o identifier da API/Resource Server (ex.: https://api.example.com ou valor registrado), <strong>não</strong> necessariamente o client_id do solicitante</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f9-86f1-f3a2ac55cb95" class="bulleted-list"><li style="list-style-type:disc">exp (expiration): maior que o tempo atual</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8063-8d86-fc4a28aeedd6" class="bulleted-list"><li style="list-style-type:disc">nbf (not before): menor ou igual ao tempo atual (opcional)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f7-8aae-dfabdd1d6920" class="bulleted-list"><li style="list-style-type:disc">iat (issued at): razoável (opcional)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8049-99d2-f7ec7ffb616f" class="bulleted-list"><li style="list-style-type:disc">sub: presente e válido</li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80f2-941c-c3648f4ef3e4" class="numbered-list" start="3"><li>Verifica scopes/roles (claims customizados) para autorização granular</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-801b-bda3-d1840991b4cd" class="numbered-list" start="4"><li>Opcional: valida jti (JWT ID) contra uma lista de revogados (blacklist), embora isso introduza estado e reduza a vantagem stateless do JWT</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8090-beb1-cdc24a06c408" class="">Se qualquer validação falhar, retorna 401 Unauthorized.</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8072-8fb7-f605d3508a3c" class=""><strong>Riscos de segurança se o token não for devidamente protegido:</strong></p></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80fb-902f-c0d3d64d8cc3" class="bulleted-list"><li style="list-style-type:disc">Roubo de access token (via XSS, MITM, log leakage) → acesso imediato aos recursos do usuário até a expiração</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-805a-bd6d-ec88f2af2770" class="bulleted-list"><li style="list-style-type:disc">Roubo de refresh token → acesso contínuo e renovável indefinidamente</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8051-91b4-e5881e338b34" class="bulleted-list"><li style="list-style-type:disc">Replay attack → token interceptado e reutilizado</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b3-88d3-cdce14d054c3" class="bulleted-list"><li style="list-style-type:disc">Token leakage em logs, URLs ou ferramentas de debug</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8058-8c3b-f548880fed60" class="bulleted-list"><li style="list-style-type:disc">JWT mal configurado (aceitação de alg: none, chave fraca, ausência de aud/iss) → forjamento de tokens</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8005-b592-c1f00f43e33d" class="bulleted-list"><li style="list-style-type:disc">Refresh token sem rotação → vazamento único compromete a sessão permanentemente</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8044-9ce8-d3ffc4eea4f8" class="bulleted-list"><li style="list-style-type:disc">Armazenamento inseguro (ex.: localStorage no browser) → exploração via XSS</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-801a-914f-d593820ba48c" class="bulleted-list"><li style="list-style-type:disc">Ausência de HTTPS → interceptação em trânsito</li></ul></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-801a-8902-ca7bcbba22ab" class=""><strong>Mitigações recomendadas:</strong></p></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8044-8083-f60404ac6b1c" class="bulleted-list"><li style="list-style-type:disc">Sempre usar HTTPS</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8046-b25d-fa2a86cf4d94" class="bulleted-list"><li style="list-style-type:disc">PKCE obrigatório para clientes públicos (SPAs/mobile)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-801e-874f-c5aed86d0d43" class="bulleted-list"><li style="list-style-type:disc">Refresh token rotation + detecção de reutilização</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c4-a97f-d61c9e507852" class="bulleted-list"><li style="list-style-type:disc">Armazenamento em HttpOnly + Secure + SameSite cookies (para web)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e8-a6d3-d705a4b5f3d1" class="bulleted-list"><li style="list-style-type:disc">Access tokens de curta duração (15–60 min)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-802b-b997-c514ca2f120e" class="bulleted-list"><li style="list-style-type:disc">Validação rigorosa de iss, aud, exp e algoritmo</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8030-99f5-dba356bb1589" class="bulleted-list"><li style="list-style-type:disc">Para revogação imediata: introspection endpoint ou blacklist distribuída</li></ul></div><div style="display:contents" dir="ltr"><figure id="308795ef-9f12-8070-aae0-fe4bef0c36a1" class="image"><a href="image.png"><img style="width:776.984375px" src="image.png"/></a></figure></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-800a-bb10-f4ce70cce29c" class=""><em>o diagrama mostra os passos visualmente.)</em></p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-801f-b7b5-d4b74d9e9200" class="">Pergunta 2: Estratégias para continuidade da conexão com token expirando</h3></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80e6-a955-eecf84a2eec2" class=""><strong>Pergunta 2:</strong> Considere o cenário de uma aplicação cliente que perde acesso ao token expirar. Quais estratégias avançadas podem ser implementadas para garantir a continuidade da conexão sem comprometer a segurança? Compare pelo menos duas abordagens (ex.: Refresh Tokens, Token Rotation, Client Credentials Flow) com vantagens e desvantagens.</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80ef-82c8-cadfe9ae3479" class=""><strong>Resposta:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80fb-9a32-f2c2d0fd212b" class=""> Para garantir a <strong>continuidade da conexão</strong> em cenários onde o access token expira (geralmente 15–60 minutos), sem forçar reautenticação frequente do usuário e sem comprometer a segurança, as principais estratégias avançadas incluem   </p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-809d-8674-d020be144498" class=""><strong>Comparação principal (Refresh Tokens vs Rotation):</strong></p></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8008-af26-f49da6d5973d" class="numbered-list" start="1"><li><strong>Uso de Refresh Tokens (com rotation recomendada)</strong><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b5-9bd4-d59da974113a" class="bulleted-list"><li style="list-style-type:disc">Descrição: Refresh token longo usado para obter novo access token curto. Rotation: cada uso emite novo refresh e invalida o antigo.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b3-8a3e-e028631804b0" class="bulleted-list"><li style="list-style-type:disc">Vantagens:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-800d-a83d-efa28f8d348a" class="bulleted-list"><li style="list-style-type:circle">Sessão contínua sem interação do usuário</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80db-98da-f06b9018e417" class="bulleted-list"><li style="list-style-type:circle">Rotation limita dano em vazamento</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8042-bea9-de97272b92d5" class="bulleted-list"><li style="list-style-type:circle">Revogação centralizada no AS</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-800c-b323-e56c13ffcd39" class="bulleted-list"><li style="list-style-type:disc">Desvantagens:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80be-ac60-e76efe748af4" class="bulleted-list"><li style="list-style-type:circle">Refresh sensível (se vazado antes da rotation)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8070-83d2-f356a2201bed" class="bulleted-list"><li style="list-style-type:circle">Overhead de chamadas</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80eb-8f7e-cc7d1217eed3" class="bulleted-list"><li style="list-style-type:circle">Armazenamento crítico (HttpOnly cookie ou backend)</li></ul></div></li></ul></div></li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8027-892b-e92da91b119f" class="numbered-list" start="2"><li><strong>Refresh Token Rotation (extensão avançada)</strong><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80db-aa15-e4ffb51aad96" class="bulleted-list"><li style="list-style-type:disc">Descrição: Refresh vira single-use; detecta abuso se antigo for reutilizado.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8002-81f6-e25278b4702c" class="bulleted-list"><li style="list-style-type:disc">Vantagens:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-804c-84f1-edbe3b893d5c" class="bulleted-list"><li style="list-style-type:circle">Alta segurança (single-use + detecção)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-806b-a180-cb55ae64a110" class="bulleted-list"><li style="list-style-type:circle">Alinha com OAuth BCP</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8092-a17b-f99dabb5fe69" class="bulleted-list"><li style="list-style-type:circle">UX seamless</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-801a-aeec-f4a78257dbbc" class="bulleted-list"><li style="list-style-type:disc">Desvantagens:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8041-a087-dff5ad2c35cb" class="bulleted-list"><li style="list-style-type:circle">Mais complexidade (gerenciar novos tokens)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-800a-a8db-cc3341f43992" class="bulleted-list"><li style="list-style-type:circle">Estado no AS</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-804e-b28d-c51625bee509" class="bulleted-list"><li style="list-style-type:circle">Race conditions possíveis</li></ul></div></li></ul></div></li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8002-b9b7-fe81ac34eaa9" class=""><strong>Comparação resumida:</strong></p></div><div style="display:contents" dir="ltr"><table id="308795ef-9f12-80f2-8e03-f73aa484b291" class="simple-table"><thead class="simple-table-header"><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80b4-a9d8-c946c987adad"><th id="j:Cx" class="simple-table-header-color simple-table-header">Critério</th><th id="CxOg" class="simple-table-header-color simple-table-header">Refresh Tokens (sem rotation)</th><th id="zAEJ" class="simple-table-header-color simple-table-header">Refresh Tokens com Rotation</th></tr></div></thead><tbody><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-807d-ac03-d91e86d66899"><td id="j:Cx" class="">Segurança contra vazamento</td><td id="CxOg" class="">Média</td><td id="zAEJ" class="">Alta</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-806d-bcee-e54c941f0b65"><td id="j:Cx" class="">UX (continuidade)</td><td id="CxOg" class="">Excelente</td><td id="zAEJ" class="">Excelente</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8064-b548-d272d932cc00"><td id="j:Cx" class="">Complexidade</td><td id="CxOg" class="">Média</td><td id="zAEJ" class="">Alta</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80f3-9568-c0dc42f71216"><td id="j:Cx" class="">Recomendação</td><td id="CxOg" class="">Evitar</td><td id="zAEJ" class="">Padrão ouro</td></tr></div></tbody></table></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80f9-a460-e680592f6732" class=""><strong>Estratégias complementares:</strong> Proactive refresh (renova antes de expirar), BFF para gerenciar tokens no backend.</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8045-b84c-f39a9c3467ff" class="">Pergunta 3: Cadeia de relacionamentos com CTE recursiva</h3></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80b1-a908-c7f87a52fa01" class=""><strong>Pergunta 3:</strong> Tabela Relacionamentos (id_origem, id_destino, tipo_relacao). Crie consulta SQL que construa cadeia de relacionamentos, detecte ciclos, retorne comprimento máximo por usuário inicial e explique eficiência em escala.</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80b3-9812-e3e42ffc5c66" class=""><strong>Resposta:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8034-b6ee-e15364ce2ff9" class="">SQL</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80b5-aeeb-f91212d229fa" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">WITH RECURSIVE relationship_chain AS (
    SELECT 
        id_origem AS start_id,
        id_origem AS current_id,
        id_destino AS next_id,
        tipo_relacao,
        1 AS depth,
        ARRAY[id_origem, id_destino] AS path,
        FALSE AS has_cycle
    FROM Relacionamentos
    WHERE id_origem = :user_id_inicial

    UNION ALL

    SELECT 
        rc.start_id,
        rc.next_id AS current_id,
        r.id_destino AS next_id,
        r.tipo_relacao,
        rc.depth + 1,
        rc.path || r.id_destino,
        CASE WHEN r.id_destino = ANY(rc.path) THEN TRUE ELSE rc.has_cycle END
    FROM relationship_chain rc
    JOIN Relacionamentos r ON rc.next_id = r.id_origem
    WHERE rc.depth &lt; 20 AND NOT rc.has_cycle
)
SELECT 
    start_id,
    path,
    depth,
    has_cycle
FROM relationship_chain
ORDER BY depth DESC;</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80ec-a307-c5f7d71bf73a" class="">
</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8063-8a3f-c11500eb7243" class=""><strong>Comprimento máximo:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8010-b61a-f1bd42cf8e4d" class="">SQL</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-8084-a18f-f03efd2f2741" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">SELECT start_id, MAX(depth) AS max_depth, BOOL_OR(has_cycle) AS tem_ciclo
FROM relationship_chain
GROUP BY start_id;</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80f6-ac25-edd9e35d626e" class=""><strong>Eficiência em escala (centenas de milhões):</strong></p></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80a8-96ce-c0490deddd04" class="bulleted-list"><li style="list-style-type:disc">Índices: (id_origem, id_destino), (id_destino, id_origem)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8013-bcfd-c39cfb9520d7" class="bulleted-list"><li style="list-style-type:disc">Particionamento: por id_origem (hash ou range)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80a5-9668-c442367d1f96" class="bulleted-list"><li style="list-style-type:disc">Limite depth &lt; 20</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8078-9392-e967abbbe71b" class="bulleted-list"><li style="list-style-type:disc">Query por usuário único + materialized view para graphs estáticos</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8070-9953-f921c1b0cc04" class="bulleted-list"><li style="list-style-type:disc">EXPLAIN ANALYZE para otimizar</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80d5-bd44-fb83d619a7b2" class="">Pergunta 4: Transações consecutivas altas</h3></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80b4-9233-d478d5b3ecf0" class=""><strong>Pergunta 4:</strong> Identificar clientes com 3+ transações &gt; R$ 10.000 consecutivas em até 7 dias, com média, datas primeira/última, usando window functions e subqueries.</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-800a-824a-d4f3fcda4a40" class=""><strong>Resposta:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8093-8121-fd0fb2d84a81" class="">SQL</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-8021-951e-c4a9e01e92dc" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">WITH transacoes_alta_valor AS (
    SELECT 
        id_cliente,
        data_transacao,
        valor,
        ROW_NUMBER() OVER (PARTITION BY id_cliente ORDER BY data_transacao) AS rn
    FROM Transacoes
    WHERE valor &gt; 10000 AND tipo_transacao IN (&#x27;compra&#x27;, &#x27;transferência&#x27;, &#x27;saque&#x27;)
),
sequencias AS (
    SELECT 
        id_cliente,
        data_transacao AS data_atual,
        valor,
        rn,
        LAG(data_transacao, 1) OVER (PARTITION BY id_cliente ORDER BY data_transacao) AS data_anterior_1,
        LAG(data_transacao, 2) OVER (PARTITION BY id_cliente ORDER BY data_transacao) AS data_anterior_2
    FROM transacoes_alta_valor
),
padroes AS (
    SELECT 
        id_cliente,
        data_anterior_2 AS data_primeira,
        data_atual AS data_ultima,
        AVG(valor) OVER (PARTITION BY id_cliente, FLOOR((rn - 2)/3)) AS valor_medio,
        COUNT(*) OVER (PARTITION BY id_cliente, FLOOR((rn - 2)/3)) AS qtd,
        (data_atual - data_anterior_2 &lt;= INTERVAL &#x27;7 days&#x27;) AS valido
    FROM sequencias
    WHERE rn &gt;= 3
)
SELECT DISTINCT ON (id_cliente, data_primeira)
    id_cliente,
    data_primeira,
    data_ultima,
    ROUND(valor_medio, 2) AS valor_medio,
    qtd
FROM padroes
WHERE valido AND qtd &gt;= 3
ORDER BY id_cliente, data_primeira DESC;</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8059-985f-f701ebb019bf" class=""><strong>Eficiência:</strong></p></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80fb-9c92-e93fec6f0689" class="bulleted-list"><li style="list-style-type:disc">Índice: (id_cliente, data_transacao, valor)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e7-8f39-fdd0e2906c06" class="bulleted-list"><li style="list-style-type:disc">Particionamento por data_transacao (range mensal)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-807b-afe2-c261062c279b" class="bulleted-list"><li style="list-style-type:disc">Limite temporal no WHERE</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80dc-8b30-e251ef3e9759" class="bulleted-list"><li style="list-style-type:disc">Materialized view para transações altas</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-808e-8544-c5cfcc4a48d7" class=""><strong>Pergunta 5:</strong> Escreva um script Python que</h3></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8097-9904-d5c3ebd37b06" class="numbered-list" start="1"><li>Conecte ao SQL Server usando variáveis de ambiente (sem hardcode de credenciais).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-807a-b441-f7c0de81d5d5" class="numbered-list" start="2"><li>Busque todos os pedidos PENDING a partir de uma data de corte (@CutoffDate), usando parametrização.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80f6-952c-db5cba54fb64" class="numbered-list" start="3"><li>Atualize esses pedidos para PROCESSED e informe na tela quantas linhas foram afetadas.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8026-9d0a-f68d07ee3717" class="numbered-list" start="4"><li>Use transação (commit/rollback) simples.</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-805f-8b5e-da5d90e36271" class="">Detalhes da tabela Sales.Orders (simplificado): OrderId (INT, PK), OrderDate (DATETIME2), Status (VARCHAR(20)).</p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-807d-a005-cb23a3864172" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-802e-8ec4-f4af7155d075" class="">Python</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-801b-84b7-c7d0ca267e11" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">import os
import pyodbc
from datetime import datetime

# Carrega variáveis de ambiente (nunca hardcode credenciais!)
DB_SERVER = os.getenv(&#x27;DB_SERVER&#x27;)          # ex: &#x27;servidor.database.windows.net&#x27;
DB_DATABASE = os.getenv(&#x27;DB_DATABASE&#x27;)      # ex: &#x27;MeuBanco&#x27;
DB_USERNAME = os.getenv(&#x27;DB_USERNAME&#x27;)
DB_PASSWORD = os.getenv(&#x27;DB_PASSWORD&#x27;)
CUTOFF_DATE = os.getenv(&#x27;CUTOFF_DATE&#x27;, &#x27;2024-01-01&#x27;)  # Pode vir de env ou ser parâmetro

# String de conexão segura
conn_str = (
    f'DRIVER={{ODBC Driver 17 for SQL Server}};'
    f'SERVER={DB_SERVER};'
    f'DATABASE={DB_DATABASE};'
    f'UID={DB_USERNAME};'
    f'PWD={DB_PASSWORD};'
    f'Trusted_Connection=no;'
    f'Encrypt=yes;'
    f'Connection Timeout=30;'
)

try:
    conn = pyodbc.connect(conn_str)
    conn.autocommit = False  # Ativa modo transação manual
    cursor = conn.cursor()

    # 1. Buscar pedidos PENDING a partir da data de corte (parametrizado)
    select_query = &quot;&quot;&quot;
    SELECT OrderId, OrderDate, Status
    FROM Sales.Orders
    WHERE Status = &#x27;PENDING&#x27;
      AND OrderDate &gt;= ?
    ORDER BY OrderDate
    &quot;&quot;&quot;
    cursor.execute(select_query, (CUTOFF_DATE,))
    pending_orders = cursor.fetchall()

    if not pending_orders:
        print(&quot;Nenhum pedido PENDING encontrado após a data de corte.&quot;)
        conn.commit()
        return

    print(f&quot;Encontrados {len(pending_orders)} pedidos PENDING para processamento.&quot;)

    # 2. Atualizar para PROCESSED (em lote para eficiência)
    update_query = &quot;&quot;&quot;
    UPDATE Sales.Orders
    SET Status = &#x27;PROCESSED&#x27;
    WHERE OrderId = ?
    &quot;&quot;&quot;
    updated_count = 0
    for order in pending_orders:
        cursor.execute(update_query, (order.OrderId,))
        updated_count += cursor.rowcount

    # 3. Commit da transação se tudo ok
    conn.commit()
    print(f&quot;Sucesso! {updated_count} pedidos atualizados para PROCESSED.&quot;)

except pyodbc.Error as e:
    # Rollback em caso de erro
    if conn:
        conn.rollback()
    print(f&quot;Erro ao processar: {e}&quot;)
    # Aqui poderia logar em arquivo ou enviar alerta

finally:
    if cursor:
        cursor.close()
    if conn:
        conn.close()</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80b7-86a5-f3e7e3efb2fa" class="">
</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8096-8380-c492d6c9655a" class=""><strong>Pergunta 6:</strong> Consumir uma API REST fictícia de pedidos</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8065-83f5-fc303d8e6305" class="bulleted-list"><li style="list-style-type:disc">Listagem paginada: GET <a href="https://api.exemplo.com/orders?status=pending&amp;page=">https://api.exemplo.com/orders?status=pending&amp;page=</a>&lt;n&gt;&amp;page_size=100<br/>Resposta: { &quot;data&quot;: [...], &quot;next_page&quot;: 3 } (ou null se acabou)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80dc-9766-dbd47c1ec8f6" class="bulleted-list"><li style="list-style-type:disc">Confirmação: POST <a href="https://api.exemplo.com/orders/%7Bid%7D/confirm">https://api.exemplo.com/orders/{id}/confirm</a><br/>Envie um header Idempotency-Key com um hash simples do orderId.</li></ul></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8088-a8c0-c0abccc29e79" class="">O script deve:</p></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80c1-a736-ff92fd12efab" class="numbered-list" start="1"><li>Obter todos os pedidos pending percorrendo as páginas até o fim.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-808d-9883-e88e7833957e" class="numbered-list" start="2"><li>Para cada pedido, chamar o POST /confirm com timeout e retry básico (até 3 tentativas) em erros 5xx ou timeout.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8034-a180-ce750d1682e9" class="numbered-list" start="3"><li>Não imprimir segredos; usar variáveis de ambiente para API_TOKEN.</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80e2-8bab-d343bb0e6cea" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8014-8706-fdde3468da38" class="">Python</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80da-a1ee-e55ce03969cb" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">import os
import requests
import hashlib
import time
from requests.exceptions import RequestException, Timeout, HTTPError

# Carrega variáveis de ambiente (nunca hardcode!)
API_TOKEN = os.getenv(&#x27;API_TOKEN&#x27;)
BASE_URL = &#x27;https://api.exemplo.com/orders&#x27;

if not API_TOKEN:
    raise ValueError(&quot;API_TOKEN não encontrado nas variáveis de ambiente.&quot;)

HEADERS = {
    &#x27;Authorization&#x27;: f&#x27;Bearer {API_TOKEN}&#x27;,
    &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,
    &#x27;Accept&#x27;: &#x27;application/json&#x27;
}

TIMEOUT = 10          # segundos
MAX_RETRIES = 3
BACKOFF_FACTOR = 2    # exponential backoff: 1s, 2s, 4s...

def get_all_pending_orders():
    &quot;&quot;&quot;
    Percorre todas as páginas de pedidos pending.
    Retorna lista de todos os pedidos.
    &quot;&quot;&quot;
    orders = []
    page = 1

    while True:
        params = {
            &#x27;status&#x27;: &#x27;pending&#x27;,
            &#x27;page&#x27;: page,
            &#x27;page_size&#x27;: 100
        }

        try:
            response = requests.get(
                f&quot;{BASE_URL}&quot;,
                headers=HEADERS,
                params=params,
                timeout=TIMEOUT
            )
            response.raise_for_status()
            data = response.json()

            orders.extend(data.get(&#x27;data&#x27;, []))

            next_page = data.get(&#x27;next_page&#x27;)
            if next_page is None:
                print(f&quot;Finalizado. Total de pedidos pending encontrados: {len(orders)}&quot;)
                break

            page = next_page
            print(f&quot;Página {page} processada...&quot;)

        except (Timeout, RequestException) as e:
            print(f&quot;Erro ao listar página {page}: {e}&quot;)
            raise  # Para este script, aborta se falhar listagem

    return orders

def confirm_order(order_id: str | int):
    &quot;&quot;&quot;
    Confirma um pedido com idempotência via header Idempotency-Key.
    Retry em 5xx e timeout (até MAX_RETRIES).
    &quot;&quot;&quot;
    # Idempotency-Key: hash simples do orderId (MD5 suficiente para idempotência)
    idempotency_key = hashlib.md5(str(order_id).encode(&#x27;utf-8&#x27;)).hexdigest()

    headers = HEADERS.copy()
    headers[&#x27;Idempotency-Key&#x27;] = idempotency_key

    url = f&quot;{BASE_URL}/{order_id}/confirm&quot;

    for attempt in range(1, MAX_RETRIES + 1):
        try:
            response = requests.post(
                url,
                headers=headers,
                timeout=TIMEOUT,
                json={}  # Corpo vazio, conforme API fictícia
            )
            response.raise_for_status()
            print(f&quot;Pedido {order_id} confirmado com sucesso (tentativa {attempt}).&quot;)
            return True

        except Timeout:
            print(f&quot;Timeout ao confirmar {order_id} (tentativa {attempt}/{MAX_RETRIES})&quot;)
        except HTTPError as e:
            status = e.response.status_code if e.response else None
            if status and 500 &lt;= status &lt; 600:
                print(f&quot;Erro 5xx ao confirmar {order_id} (tentativa {attempt}/{MAX_RETRIES}): {status}&quot;)
            else:
                print(f&quot;Erro não-retriável ao confirmar {order_id}: {e}&quot;)
                raise  # Erros 4xx abortam
        except RequestException as e:
            print(f&quot;Erro de rede ao confirmar {order_id} (tentativa {attempt}/{MAX_RETRIES}): {e}&quot;)

        if attempt &lt; MAX_RETRIES:
            sleep_time = BACKOFF_FACTOR ** (attempt - 1)
            print(f&quot;Aguardando {sleep_time}s antes de retry...&quot;)
            time.sleep(sleep_time)
        else:
            print(f&quot;Falha definitiva ao confirmar pedido {order_id} após {MAX_RETRIES} tentativas.&quot;)
            return False

    return False

def main():
    print(&quot;Iniciando processamento de pedidos pending...&quot;)
    try:
        pending_orders = get_all_pending_orders()

        if not pending_orders:
            print(&quot;Nenhum pedido para confirmar.&quot;)
            return

        success_count = 0
        fail_count = 0

        for order in pending_orders:
            # Supondo que &#x27;id&#x27; seja o campo do orderId na resposta da API
            order_id = order.get(&#x27;id&#x27;) or order.get(&#x27;OrderId&#x27;)
            if not order_id:
                print(f&quot;Pedido sem ID válido: {order}&quot;)
                continue

            if confirm_order(order_id):
                success_count += 1
            else:
                fail_count += 1

        print(&quot;\nResumo final:&quot;)
        print(f&quot;  Confirmados com sucesso: {success_count}&quot;)
        print(f&quot;  Falharam: {fail_count}&quot;)
        print(f&quot;  Total processados: {success_count + fail_count}&quot;)

    except Exception as e:
        print(f&quot;Erro crítico no processamento: {e}&quot;)

if __name__ == &#x27;__main__&#x27;:
    main()</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-806b-acf7-c0ecbfa63a85" class="">
</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80b6-bfe7-c37b0b464db4" class=""><strong>Pergunta 7:</strong> Implemente a função normalizeUsers(input) que recebe um array com objetos de usuários e retorna um novo array com as seguintes normalizações</h3></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8072-9521-ced58cdbb63f" class="numbered-list" start="1"><li>id: converter para number (descartar item se não for convertível).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-800a-b423-c95d4fcc65ea" class="numbered-list" start="2"><li>name: trim + colapsar múltiplos espaços + Title Case simples (ex.: &quot;mARIA da silva&quot; → &quot;Maria Da Silva&quot;).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-803b-9438-db1939cf569f" class="numbered-list" start="3"><li>email: lowercase e trim.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-807a-af64-e95a315bd04d" class="numbered-list" start="4"><li>active: aceitar true/false, &quot;true&quot;/&quot;false&quot;, 1/0 → converter para boolean.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80a1-b080-ecae43db2123" class="numbered-list" start="5"><li>tags: aceitar string &quot;a, b, A&quot; ou array; retornar array normalizado: minúsculas, sem espaços, sem duplicatas, ordenado.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8027-b365-c83cadca2e22" class="numbered-list" start="6"><li>Não mutar o array original.</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8094-918a-caf849a35dc9" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8045-a42b-cc71f6e57533" class="">Python</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80fb-b5ad-fc2d5dd85139" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">def normalizeUsers(input_list):
    &quot;&quot;&quot;
    Normaliza uma lista de dicionários de usuários conforme as regras especificadas.
    Retorna uma nova lista sem mutar a original.
    
    Exemplo de input:
    [
        {&quot;id&quot;: &quot;123&quot;, &quot;name&quot;: &quot; mARIA  da  silva &quot;, &quot;email&quot;: &quot; Maria@Exemplo.COM &quot;, &quot;active&quot;: &quot;true&quot;, &quot;tags&quot;: &quot;python, Python, data&quot;},
        {&quot;id&quot;: 456, &quot;name&quot;: &quot;joão silva&quot;, &quot;email&quot;: &quot;joao@gmail.com&quot;, &quot;active&quot;: 1, &quot;tags&quot;: [&quot;dev&quot;, &quot;backend&quot;]},
        {&quot;id&quot;: &quot;abc&quot;, &quot;name&quot;: &quot;inválido&quot;, ...}  # será descartado
    ]
    &quot;&quot;&quot;
    normalized = []
    
    for user in input_list:
        # 1. id: tenta converter para int; descarta se falhar
        try:
            user_id = int(user.get(&#x27;id&#x27;))
        except (ValueError, TypeError):
            continue  # descarta item inválido
        
        # 2. name: trim, colapsar espaços múltiplos, Title Case
        name = user.get(&#x27;name&#x27;, &#x27;&#x27;).strip()
        name = &#x27; &#x27;.join(name.split())  # remove múltiplos espaços
        name = &#x27; &#x27;.join(word.capitalize() for word in name.split())  # Title Case
        
        # 3. email: lowercase + trim
        email = user.get(&#x27;email&#x27;, &#x27;&#x27;).strip().lower()
        
        # 4. active: converte para bool de várias formas
        active_val = user.get(&#x27;active&#x27;)
        if isinstance(active_val, bool):
            active = active_val
        elif isinstance(active_val, str):
            active = active_val.lower() in (&#x27;true&#x27;, &#x27;1&#x27;, &#x27;yes&#x27;, &#x27;on&#x27;)
        elif isinstance(active_val, (int, float)):
            active = bool(active_val)
        else:
            active = False  # default seguro se inválido
        
        # 5. tags: normaliza para lista de str minúsculas, sem espaços, unique, ordenada
        tags_val = user.get(&#x27;tags&#x27;, [])
        if isinstance(tags_val, str):
            tags = [t.strip().lower() for t in tags_val.split(&#x27;,&#x27;) if t.strip()]
        elif isinstance(tags_val, (list, tuple)):
            tags = [str(t).strip().lower() for t in tags_val if t]
        else:
            tags = []
        
        # Remove duplicatas e ordena
        tags = sorted(set(tags))
        
        # Monta o objeto normalizado
        normalized.append({
            &#x27;id&#x27;: user_id,
            &#x27;name&#x27;: name,
            &#x27;email&#x27;: email,
            &#x27;active&#x27;: active,
            &#x27;tags&#x27;: tags
        })
    
    return normalized</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8092-9ad4-f6932ae2db34" class=""><strong>Exemplo de uso e teste :</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-8034-bf01-c47d813d065b" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all"># Teste
users = [
    {&quot;id&quot;: &quot;123&quot;, &quot;name&quot;: &quot; mARIA  da  silva &quot;, &quot;email&quot;: &quot; Maria@Exemplo.COM &quot;, &quot;active&quot;: &quot;true&quot;, &quot;tags&quot;: &quot;python, Python, data&quot;},
    {&quot;id&quot;: 456, &quot;name&quot;: &quot;joão silva&quot;, &quot;email&quot;: &quot;joao@gmail.com&quot;, &quot;active&quot;: 1, &quot;tags&quot;: [&quot;dev&quot;, &quot;backend&quot;, &quot;dev&quot;]},
    {&quot;id&quot;: &quot;abc&quot;, &quot;name&quot;: &quot;inválido&quot;, &quot;email&quot;: &quot;teste&quot;, &quot;active&quot;: &quot;sim&quot;, &quot;tags&quot;: &quot;a, b,  c&quot;},
    {&quot;id&quot;: &quot;não-numérico&quot;, &quot;name&quot;: &quot;descartado&quot;}
]

resultado = normalizeUsers(users)
print(resultado)</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-801f-8253-d84f155995c9" class=""><strong>Saída esperada aproximada:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-8005-9ad5-c339929fd645" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">[
    {&#x27;id&#x27;: 123, &#x27;name&#x27;: &#x27;Maria Da Silva&#x27;, &#x27;email&#x27;: &#x27;maria@exemplo.com&#x27;, &#x27;active&#x27;: True, &#x27;tags&#x27;: [&#x27;data&#x27;, &#x27;python&#x27;]},
    {&#x27;id&#x27;: 456, &#x27;name&#x27;: &#x27;João Silva&#x27;, &#x27;email&#x27;: &#x27;joao@gmail.com&#x27;, &#x27;active&#x27;: True, &#x27;tags&#x27;: [&#x27;backend&#x27;, &#x27;dev&#x27;]},
    {&#x27;id&#x27;: None, ...}  # não, o terceiro tem id válido? No exemplo &quot;não-numérico&quot; é descartado
]</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8083-9c4a-d31c6f226132" class="">
</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80bc-84ac-fb489ff5282a" class=""><strong>Pergunta 8:</strong> Implemente deepKeyMap(obj, keyFn, maxDepth = Infinity) que</h3></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80c8-b630-faa959a73f9b" class="numbered-list" start="1"><li>Recebe um objeto/array e retorna uma cópia com as chaves de objetos transformadas por keyFn(key).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8025-ade1-eb7cc38a4794" class="numbered-list" start="2"><li>Mantém arrays como arrays, sem mudar a ordem.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-800a-b5a0-d4b21f7f7241" class="numbered-list" start="3"><li>Respeita maxDepth: ao ultrapassar, para de transformar a partir daquele nível (retorna como está).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8097-9152-f2b6564a193c" class="numbered-list" start="4"><li>Ignora tipos atômicos (string, number, boolean, null, Date, Function, etc.).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-804f-9a0e-db24e99aaa16" class="numbered-list" start="5"><li>Não precisa tratar ciclos (para simplificar), mas não pode mutar o original.</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8055-937a-e84e2a16d9d5" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-805d-a3c8-eb022cf087c1" class="">Python</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80a1-8e4d-db8932cc5fe4" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">import copy

def deepKeyMap(obj, keyFn, maxDepth=float(&#x27;inf&#x27;), current_depth=0):
    &quot;&quot;&quot;
    Cria uma cópia profunda do objeto/array, transformando as chaves de dicionários
    usando a função keyFn(key). Para em maxDepth e retorna o valor como está.
    
    - Não muta o original.
    - Preserva ordem de arrays.
    - Ignora tipos primitivos e não-dicionários/listas.
    - Não trata ciclos (pode entrar em loop infinito se houver).
    
    Exemplo:
    def snake_to_camel(key): return &#x27;&#x27;.join(word.capitalize() for word in key.split(&#x27;_&#x27;))
    deepKeyMap({&#x27;user_name&#x27;: &#x27;Davis&#x27;, &#x27;age&#x27;: 30, &#x27;address&#x27;: {&#x27;street_name&#x27;: &#x27;Rua X&#x27;}}, snake_to_camel)
    → {&#x27;UserName&#x27;: &#x27;Davis&#x27;, &#x27;Age&#x27;: 30, &#x27;Address&#x27;: {&#x27;StreetName&#x27;: &#x27;Rua X&#x27;}}
    &quot;&quot;&quot;
    # Se já passou do maxDepth, retorna cópia rasa (não transforma mais)
    if current_depth &gt;= maxDepth:
        return copy.copy(obj)
    
    # Tipos atômicos / primitivos: retorna como está (sem cópia profunda)
    if not isinstance(obj, (dict, list)):
        return obj
    
    # Cria cópia profunda para evitar mutação
    obj_copy = copy.deepcopy(obj)
    
    if isinstance(obj_copy, dict):
        result = {}
        for key, value in obj_copy.items():
            # Aplica a transformação apenas na chave
            new_key = keyFn(key)
            # Recursão com depth +1
            result[new_key] = deepKeyMap(value, keyFn, maxDepth, current_depth + 1)
        return result
    
    elif isinstance(obj_copy, list):
        # Mantém arrays como estão, só recursão nos itens
        return [
            deepKeyMap(item, keyFn, maxDepth, current_depth + 1)
            for item in obj_copy
        ]
    
    # Caso raro (outros iteráveis?), retorna cópia
    return obj_copy</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8001-9831-df57da5e74ad" class=""><strong>Exemplo de uso e teste:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80a5-93f1-e84962b398a0" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all"># Função auxiliar de exemplo: snake_case → camelCase
def snake_to_camel(key):
    parts = key.split(&#x27;_&#x27;)
    return parts[0] + &#x27;&#x27;.join(word.capitalize() for word in parts[1:])

# Dados de teste
data = {
    &#x27;user_info&#x27;: {
        &#x27;full_name&#x27;: &#x27;Davis Pereira&#x27;,
        &#x27;email_address&#x27;: &#x27;davisvasconcellos@gmail.com&#x27;,
        &#x27;is_active&#x27;: True,
        &#x27;preferences&#x27;: [&#x27;dark_mode&#x27;, &#x27;notifications_off&#x27;, &#x27;dark_mode&#x27;]
    },
    &#x27;order_history&#x27;: [
        {&#x27;order_id&#x27;: 123, &#x27;total_value&#x27;: 1500.50},
        {&#x27;order_id&#x27;: 456, &#x27;items&#x27;: [&#x27;item_a&#x27;, &#x27;item_b&#x27;]}
    ]
}

# Chamada com maxDepth=2 (para demonstrar parada)
normalized = deepKeyMap(data, snake_to_camel, maxDepth=2)

print(normalized)</code></pre></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80c5-ad8f-da82935f25c7" class=""><strong>Saída esperada aproximada:</strong></p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-80a3-96fe-f79040522921" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">{
    &#x27;UserInfo&#x27;: {
        &#x27;FullName&#x27;: &#x27;Davis Pereira&#x27;,
        &#x27;EmailAddress&#x27;: &#x27;davisvasconcellos@gmail.com&#x27;,
        &#x27;IsActive&#x27;: True,
        &#x27;Preferences&#x27;: [&#x27;dark_mode&#x27;, &#x27;notifications_off&#x27;, &#x27;dark_mode&#x27;]  # array não muda chaves
    },
    &#x27;OrderHistory&#x27;: [
        {&#x27;OrderId&#x27;: 123, &#x27;TotalValue&#x27;: 1500.50},  # transformou até depth=2
        {&#x27;OrderId&#x27;: 456, &#x27;Items&#x27;: [&#x27;item_a&#x27;, &#x27;item_b&#x27;]}  # parou em depth=2, não transformou &#x27;items&#x27;
    ]
}</code></pre></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-802f-a5b1-f7cf8a7722e0" class=""><strong>Pergunta 9:</strong> Um sistema externo envia doações com os campos: fullName, email, amount, donationDate, externalDonationId, recurring (booleano).<br/>Descreva o desenho técnico para integrar essas doações ao Salesforce NPSP, garantindo:</h3></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80aa-81a3-fbce425d5194" class="numbered-list" start="1"><li>Deduplicação do doador (Contact) e uso correto de Household Account.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8016-8eb9-e2ee64746bc9" class="numbered-list" start="2"><li>Criação/atualização de Opportunity (Donation) e, quando aplicável, Recurring Donation.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8084-9c9a-cfad20261929" class="numbered-list" start="3"><li>Idempotência (não criar duplicatas em chamadas repetidas) para doação pontual e recorrente.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8048-a346-f75e413e9fc1" class="numbered-list" start="4"><li>Escolha do(s) método(s)/API(s) (REST, Composite, Bulk v2, Outbound Message, etc.) e quando usar cada um.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80f3-bd21-fa52fdd393d0" class="numbered-list" start="5"><li>Estratégia de lote, erro e reprocessamento (como lidará com limites de API, falhas parciais e retries).</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8049-be05-d94c18b9edcb" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80e2-8262-ef113984573f" class="">O desenho técnico para integrar doações de um sistema externo ao <strong>Salesforce Nonprofit Success Pack (NPSP)</strong> deve priorizar <strong>deduplicação robusta</strong>, <strong>idempotência total</strong>, <strong>uso correto do modelo Household</strong> e <strong>resiliência</strong> (limites de API, erros parciais, retries). Aqui está o desenho recomendado em 2026:</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80f5-9b1b-f5f0797ec172" class="">1. Deduplicação do Doador (Contact) e uso correto de Household Account</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ed-8fb4-db36c59d4848" class="bulleted-list"><li style="list-style-type:disc"><strong>Matching Rules + Duplicate Rules nativas do NPSP</strong> (recomendado principal):<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8074-80cf-c561d949e294" class="bulleted-list"><li style="list-style-type:circle">Ative/estenda as regras padrão do NPSP para Contacts:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8063-abe9-ca5c9ab6cd59" class="bulleted-list"><li style="list-style-type:square">Fuzzy match em <strong>Email</strong> (exato ou fuzzy 85–90%)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-806c-b909-e8e7ec5c3fa8" class="bulleted-list"><li style="list-style-type:square">Fuzzy match em <strong>Full Name</strong> (FirstName + LastName)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c3-9616-d3d115d97432" class="bulleted-list"><li style="list-style-type:square">Endereço (se disponível) para reforçar Household</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8076-bf2c-e15f055a9d2d" class="bulleted-list"><li style="list-style-type:circle">Household Account: NPSP cria/atualiza automaticamente a Account do tipo Household ao criar Contact sem Account associada. Use o campo <strong>npe01__Household__c</strong> ou triggers NPSP para garantir associação.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8005-8c6c-dc342dd2148a" class="bulleted-list"><li style="list-style-type:disc"><strong>Busca prévia via SOQL (fallback/override)</strong>:<br/>Antes de criar, faça query:<div style="display:contents" dir="auto"><p id="308795ef-9f12-808d-89f8-f094e9aa0f44" class="">SQL</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-802d-be70-f22a5103a3dd" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">SELECT Id, AccountId, npe01__Household__c 
FROM Contact 
WHERE Email = :email OR (FirstName = :firstName AND LastName = :lastName)
LIMIT 1</code></pre></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8084-8b78-cb5635254e9d" class="bulleted-list"><li style="list-style-type:circle">Se encontrar → use o Contact existente (update).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e9-ba92-ea90dacbcf7a" class="bulleted-list"><li style="list-style-type:circle">Se múltiplos → use o mais recente ou aplique lógica de merge manual via API.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b5-ba76-d8cd748b7095" class="bulleted-list"><li style="list-style-type:circle">Se não encontrar → crie novo Contact → NPSP associa ao Household automaticamente.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-806f-b76d-c82506921558" class="">2. Criação/atualização de Opportunity (Donation) e Recurring Donation</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d4-86d7-ea14f33abfb9" class="bulleted-list"><li style="list-style-type:disc"><strong>Doação pontual (recurring = false)</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-809a-99df-debc1efa520c" class="bulleted-list"><li style="list-style-type:circle">Crie <strong>Opportunity</strong> com:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-807e-9c73-f84a0dc47725" class="bulleted-list"><li style="list-style-type:square">StageName = &#x27;Closed Won&#x27;</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8036-b935-da8381877f77" class="bulleted-list"><li style="list-style-type:square">CloseDate = donationDate</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80db-8d93-f02a40a52c9e" class="bulleted-list"><li style="list-style-type:square">Amount = amount</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8072-a39a-d7e20c5b4f39" class="bulleted-list"><li style="list-style-type:square">Type = &#x27;Donation&#x27;</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8044-b6be-f545346ba771" class="bulleted-list"><li style="list-style-type:square">AccountId = Household do Contact</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8064-819e-e24561cddef8" class="bulleted-list"><li style="list-style-type:square">npsp__Primary_Contact__c = Contact Id</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-803c-b614-f2fe3e5090d0" class="bulleted-list"><li style="list-style-type:square">External Id custom (ex.: External_Donation_Id__c = externalDonationId)</li></ul></div></li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80bf-aff8-f7f3523c9020" class="bulleted-list"><li style="list-style-type:disc"><strong>Doação recorrente (recurring = true)</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8067-a506-e6dd7207fd20" class="bulleted-list"><li style="list-style-type:circle">Crie/atualize <strong>npe03__Recurring_Donation__c</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8041-97c9-e5ad5dfb2d00" class="bulleted-list"><li style="list-style-type:square">npe03__Contact__c = Contact Id</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ef-ab3c-e3a60e6ae664" class="bulleted-list"><li style="list-style-type:square">npe03__Amount__c = amount</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80af-9279-fe0609b6e4eb" class="bulleted-list"><li style="list-style-type:square">npe03__Installment_Period__c = &#x27;Monthly&#x27; (ou mapeie conforme origem)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-800e-b539-eb9dead88e8a" class="bulleted-list"><li style="list-style-type:square">npe03__Next_Payment_Date__c = donationDate</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8022-8a76-f3ef4e1a635d" class="bulleted-list"><li style="list-style-type:square">External_Donation_Id__c = externalDonationId</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8057-8cd5-efef2a6c4f8d" class="bulleted-list"><li style="list-style-type:circle">NPSP gera Opportunities automáticas para parcelas futuras.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8040-b46d-c4b0ee3b50de" class="bulleted-list"><li style="list-style-type:disc"><strong>Upsert via External Id</strong>: Use campo custom External_Donation_Id__c (External ID) em Opportunity e Recurring Donation para upsert (update se existe, insert se não).</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8001-8414-e598827f4e1b" class="">3. Idempotência (não criar duplicatas)</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b2-809f-c8755b30e719" class="bulleted-list"><li style="list-style-type:disc"><strong>Mecanismo principal</strong>: <strong>Upsert</strong> via External Id<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d2-b8a4-f1ddb1da8bc6" class="bulleted-list"><li style="list-style-type:circle">REST API: POST /sobjects/Opportunity/External_Donation_Id__c/{externalDonationId} com allOrNone=false</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8052-9c38-e5ab465db612" class="bulleted-list"><li style="list-style-type:circle">Mesmo para npe03__Recurring_Donation__c</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-806f-9bcc-e9497d6d1c65" class="bulleted-list"><li style="list-style-type:circle">Isso garante: mesma doação enviada 2x → atualiza, não duplica.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-803e-b436-f21d4cd4eb8a" class="bulleted-list"><li style="list-style-type:disc"><strong>Pré-validação</strong>: Antes de upsert, query por External_Donation_Id__c → se existir e valores iguais → skip (idempotente).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f8-9c49-d7868b1a484b" class="bulleted-list"><li style="list-style-type:disc"><strong>Recorrente</strong>: Para doações recorrentes, verifique se Recurring Donation já existe → se sim, atualize Amount/Next Payment Date se necessário; se não, crie.</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8074-a7d9-d3e8882cdf0c" class="">4. Escolha de método(s)/API(s)</h3></div><div style="display:contents" dir="ltr"><table id="308795ef-9f12-8069-92c2-e23fcb417ef1" class="simple-table"><thead class="simple-table-header"><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8078-b2f9-d12c53df3fa4"><th id="\?^|" class="simple-table-header-color simple-table-header">Cenário / Volume</th><th id="N]rb" class="simple-table-header-color simple-table-header">API Recomendada</th><th id="dqmP" class="simple-table-header-color simple-table-header">Quando usar</th><th id="p}tK" class="simple-table-header-color simple-table-header">Vantagens</th><th id="&lt;nM}" class="simple-table-header-color simple-table-header">Limites / Cuidados</th></tr></div></thead><tbody><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8036-abcf-c829da9ea734"><td id="\?^|" class="">Real-time / baixa-média volume (até ~200 por minuto)</td><td id="N]rb" class="">REST API + Composite API</td><td id="dqmP" class="">Integração síncrona, uma doação por evento</td><td id="p}tK" class="">Transacional (Composite), rápido, fácil debug</td><td id="&lt;nM}" class="">100 calls/min por user, 200 por Composite</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8029-98dc-cd2770cdd091"><td id="\?^|" class="">Criação Contact + Household + Opportunity em uma chamada</td><td id="N]rb" class="">Composite API</td><td id="dqmP" class="">Criar/atualizar doador + doação atomicamente</td><td id="p}tK" class="">Reduz chamadas, transacional</td><td id="&lt;nM}" class="">Até 25 subrequests por Composite</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80b0-a56b-e1bdcf837a25"><td id="\?^|" class="">Alta volume (milhares/dia)</td><td id="N]rb" class="">Bulk API v2</td><td id="dqmP" class="">Processamento assíncrono de lotes (CSV/JSON)</td><td id="p}tK" class="">Muito eficiente, até 10.000 records por job</td><td id="&lt;nM}" class="">Assíncrono, precisa polling status</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80db-8a6a-cb94ead00c33"><td id="\?^|" class="">Notificações de erro/auditoria</td><td id="N]rb" class="">Outbound Message / Platform Events</td><td id="dqmP" class="">Salesforce notifica sistema externo em falhas ou sucesso</td><td id="p}tK" class="">Fire-and-forget, sem polling</td><td id="&lt;nM}" class="">Limitado a 1000 mensagens/dia (Outbound)</td></tr></div></tbody></table></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-806a-8bdc-d8bfcb78aa3a" class=""><strong>Recomendação principal (2026)</strong>:</p></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8080-93e0-f9c2913ead10" class="bulleted-list"><li style="list-style-type:disc"><strong>Real-time/low volume</strong> → Composite API (Contact + Household + Opportunity/Recurring em uma chamada).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e4-9820-c8f5c885ba12" class="bulleted-list"><li style="list-style-type:disc"><strong>High volume</strong> → Bulk API v2 (envie lotes de 200–10.000 doações, polling para status).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80cb-8316-c864b45e45bc" class="bulleted-list"><li style="list-style-type:disc"><strong>Fallback</strong> → REST single para debug/testes.</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80b7-b2b6-c2400d9fc0bd" class="">5. Estratégia de lote, erro e reprocessamento</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-808c-a796-edb92edd2d0b" class="bulleted-list"><li style="list-style-type:disc"><strong>Lote</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8099-a7e9-ed0a92579bc5" class="bulleted-list"><li style="list-style-type:circle">Real-time: Composite (até 25 subrequests) ou REST em loop com delay.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-801a-aa4b-cddb6deebde4" class="bulleted-list"><li style="list-style-type:circle">Batch: Bulk v2 jobs de 200–2000 records (JSON ou CSV), enviados a cada 5–15 min via scheduler (ex.: Lambda cron, Heroku Scheduler, Apex schedulable).</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f3-a333-fad3404f2941" class="bulleted-list"><li style="list-style-type:disc"><strong>Limites de API</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8092-a381-dabdba5c0b24" class="bulleted-list"><li style="list-style-type:circle">REST/Composite: 100 calls/min por user → use queue (SQS, RabbitMQ) + rate limiter (ex.: token bucket).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8034-91cd-d39e0e62f1be" class="bulleted-list"><li style="list-style-type:circle">Bulk: 15.000 batches/dia, 5 jobs simultâneos → ideal para picos.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d5-84d0-cd4960d2aed9" class="bulleted-list"><li style="list-style-type:disc"><strong>Tratamento de erros</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-800e-afd7-d7b6f0409a22" class="bulleted-list"><li style="list-style-type:circle"><strong>Falhas parciais</strong> (Bulk): Use allOrNone=false → processa o que der, loga falhas.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80bc-9084-d731d2993ebc" class="bulleted-list"><li style="list-style-type:circle"><strong>Erros 4xx/5xx</strong>: Retry exponential backoff (3–5 tentativas, 2s → 4s → 8s).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8050-bb1b-ecc3515e15b1" class="bulleted-list"><li style="list-style-type:circle"><strong>Dead Letter Queue (DLQ)</strong>: Falhas definitivas vão para fila DLQ (SQS ou Kafka) → reprocessamento manual ou automático após X horas.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e5-a04e-c80863541aa2" class="bulleted-list"><li style="list-style-type:circle"><strong>Logs/Monitoramento</strong>: Salesforce Event Monitoring + external (Datadog, Sentry) para rastrear falhas por externalDonationId.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e5-bd7d-e0dfe41531d1" class="bulleted-list"><li style="list-style-type:disc"><strong>Reprocessamento</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f8-8da2-db091007b100" class="bulleted-list"><li style="list-style-type:circle">Armazene payloads originais em fila (SQS) com retry count.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8009-ab4a-d46a86186387" class="bulleted-list"><li style="list-style-type:circle">Scheduler reenvia mensagens da DLQ periodicamente.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8059-920e-ed0082e30d00" class="bulleted-list"><li style="list-style-type:circle">Idempotência via External Id garante segurança mesmo em reenvios.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80c9-9ef7-d4c5b32f9a91" class=""><br/></p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80b9-be7f-f2442fe37f44" class=""><strong>Pergunta 10:</strong> Um sistema externo envia eventos de engajamento (ex.: inscrição em evento, clique, visita) para acionar uma Jornada no Journey Builder. Explique como você</h3></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-809a-b971-e1aa126b4266" class="numbered-list" start="1"><li>Modelaria Data Extensions (DE) para upsert (chaves, campos de controle).</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-804f-9307-caab60973927" class="numbered-list" start="2"><li>Inseriria/atualizaria dados na DE via REST API.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-80ac-afba-fe1dba66c4c8" class="numbered-list" start="3"><li>Dispararia um Entry Event (Journey Builder) sem duplicar entradas.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8057-8b02-e52679179d03" class="numbered-list" start="4"><li>Trataria OAuth2, limites de API (throttle) e retries.</li></ol></div><div style="display:contents" dir="auto"><ol type="1" id="308795ef-9f12-8029-804c-c00e938a4629" class="numbered-list" start="5"><li>Mediria e acompanharia a integração (logs, monitoramento, DLQ).</li></ol></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-8047-8538-da0ac2b9f0be" class=""><strong>Resposta completa:</strong></p></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80c5-ab38-e45a6da9949a" class="">A integração de eventos de engajamento de um sistema externo ao <strong>Salesforce Marketing Cloud (SFMC) Journey Builder</strong> deve ser <strong>idempotente</strong>, <strong>resiliente</strong> e <strong>monitorável</strong>, garantindo que cada evento acione exatamente uma entrada na Jornada sem duplicatas.</p></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80b5-a8a8-d43755e2849c" class="">1. Modelagem de Data Extensions (DE)</h3></div><div style="display:contents" dir="auto"><p id="308795ef-9f12-80f6-bad8-c26e8330fb8a" class=""><strong>DE principal: EngagementEvents</strong> (para upsert e entrada na Jornada)</p></div><div style="display:contents" dir="ltr"><table id="308795ef-9f12-8074-bbbc-fc0691aa47f9" class="simple-table"><thead class="simple-table-header"><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-804c-a54b-fa1b8c9ce7cd"><th id="iDWv" class="simple-table-header-color simple-table-header">Campo</th><th id="i@Q_" class="simple-table-header-color simple-table-header">Tipo</th><th id="cRRs" class="simple-table-header-color simple-table-header">Requisitos / Uso</th><th id="Zd{g" class="simple-table-header-color simple-table-header">Chave / Índice</th></tr></div></thead><tbody><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8080-8f20-db3d4e2db7b2"><td id="iDWv" class="">EventId</td><td id="i@Q_" class="">Text (50)</td><td id="cRRs" class="">Primary Key / External Key (ex.: UUID ou hash do evento)</td><td id="Zd{g" class="">Primary Key</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-808b-b4d8-dbdae2b1d7e4"><td id="iDWv" class="">ContactKey</td><td id="i@Q_" class="">Text (100)</td><td id="cRRs" class="">Email ou Subscriber Key (para link com Contact)</td><td id="Zd{g" class="">Indexed</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80c3-93b4-c4a2ef4f0781"><td id="iDWv" class="">EventType</td><td id="i@Q_" class="">Text (50)</td><td id="cRRs" class="">Tipo: &quot;inscricao_evento&quot;, &quot;clique_link&quot;, &quot;visita_pagina&quot;, etc.</td><td id="Zd{g" class="">Indexed</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80fe-bb09-dc7174f95184"><td id="iDWv" class="">EventDate</td><td id="i@Q_" class="">Date</td><td id="cRRs" class="">Data/hora do evento (UTC)</td><td id="Zd{g" class="">Indexed</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-804e-880e-fbda5c5afeb1"><td id="iDWv" class="">EventSource</td><td id="i@Q_" class="">Text (50)</td><td id="cRRs" class="">Origem: &quot;site&quot;, &quot;app&quot;, &quot;email&quot;, &quot;form&quot;</td><td id="Zd{g" class=""></td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80a8-b32e-fdbbf66cab6f"><td id="iDWv" class="">EventDetails</td><td id="i@Q_" class="">Text (4000)</td><td id="cRRs" class="">JSON ou descrição adicional (ex.: {&quot;url&quot;: &quot;...&quot;, &quot;campaign&quot;: &quot;verao2026&quot;})</td><td id="Zd{g" class=""></td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80f5-952b-de0c9be69833"><td id="iDWv" class="">Processed</td><td id="i@Q_" class="">Boolean</td><td id="cRRs" class="">Default: false → true após entrada na Jornada</td><td id="Zd{g" class="">Indexed</td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8028-9b77-f05ac3311eac"><td id="iDWv" class="">ProcessedDate</td><td id="i@Q_" class="">Date</td><td id="cRRs" class="">Data/hora do processamento (para auditoria)</td><td id="Zd{g" class=""></td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8025-bda2-c88132472b3a"><td id="iDWv" class="">ErrorCount</td><td id="i@Q_" class="">Number</td><td id="cRRs" class="">Contador de falhas (para retry)</td><td id="Zd{g" class=""></td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-80f3-9a90-d280dd672712"><td id="iDWv" class="">LastErrorMessage</td><td id="i@Q_" class="">Text (2000)</td><td id="cRRs" class="">Último erro (opcional)</td><td id="Zd{g" class=""></td></tr></div><div style="display:contents" dir="ltr"><tr id="308795ef-9f12-8045-b184-dc3fb51a4479"><td id="iDWv" class="">InsertedDate</td><td id="i@Q_" class="">Date</td><td id="cRRs" class="">Data de inserção (default NOW())</td><td id="Zd{g" class=""></td></tr></div></tbody></table></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80cc-ab03-fa6b73b595b8" class="bulleted-list"><li style="list-style-type:disc"><strong>Chave para upsert</strong>: EventId (External Key) → garante idempotência.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b5-afbc-e06649b1b845" class="bulleted-list"><li style="list-style-type:disc"><strong>Contato link</strong>: Use ContactKey (email ou subscriber key) para join com All Contacts.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-806c-a549-df55face6a2c" class="bulleted-list"><li style="list-style-type:disc"><strong>DE de controle (opcional)</strong>: FailedEvents (para DLQ) com mesmos campos + Reason, RetryCount.</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-808c-8ed5-ce7fe14aee28" class="">2. Inserção/atualização via REST API</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-804b-bbf4-e5fd77448a76" class="bulleted-list"><li style="list-style-type:disc"><strong>Endpoint</strong>: /hub/v1/dataevents/key:{DE_Key}/rowset (para batch upsert)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8071-9634-c545f1984992" class="bulleted-list"><li style="list-style-type:disc"><strong>Método</strong>: POST</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c1-89df-d6fde1af516e" class="bulleted-list"><li style="list-style-type:disc"><strong>Payload exemplo (single row)</strong>:<div style="display:contents" dir="auto"><p id="308795ef-9f12-8012-8776-d044e79c11c9" class="">JSON</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-808e-8a54-ee39ef1d198a" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">{
  &quot;items&quot;: [
    {
      &quot;keys&quot;: { &quot;EventId&quot;: &quot;evt-uuid-123456&quot; },
      &quot;values&quot;: {
        &quot;ContactKey&quot;: &quot;davisvasconcellos@gmail.com&quot;,
        &quot;EventType&quot;: &quot;inscricao_evento&quot;,
        &quot;EventDate&quot;: &quot;2026-02-14T14:30:00Z&quot;,
        &quot;Processed&quot;: false,
        &quot;InsertedDate&quot;: &quot;2026-02-14T14:30:00Z&quot;
      }
    }
  ]
}</code></pre></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-805d-a637-dc18532ecd66" class="bulleted-list"><li style="list-style-type:disc"><strong>Upsert automático</strong>: SFMC atualiza se EventId existe; insere se não.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8017-8677-c24b7debdbd6" class="bulleted-list"><li style="list-style-type:disc"><strong>Batch</strong>: Envie até 2000 itens por chamada (limite recomendado).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c0-9998-f01485732462" class="bulleted-list"><li style="list-style-type:disc"><strong>Biblioteca recomendada</strong>: FuelSDK-Python ou requests + OAuth manual.</li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8028-93d6-c95dcfddd74e" class="">3. Disparar Entry Event no Journey Builder sem duplicar entradas</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-809f-b3e0-dc5edebac4ad" class="bulleted-list"><li style="list-style-type:disc"><strong>Configuração da Jornada</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ca-97fa-fb43b5db6b9f" class="bulleted-list"><li style="list-style-type:circle">Entry Source: <strong>Data Extension</strong></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80e8-b748-e1e804613b98" class="bulleted-list"><li style="list-style-type:circle">DE: EngagementEvents</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80a0-a73e-fe6d4d36866d" class="bulleted-list"><li style="list-style-type:circle">Filtro de entrada: Processed = false AND EventDate &gt; {{now minus 7 days}} (evita reentradas antigas)</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8029-84d7-d9854b88f351" class="bulleted-list"><li style="list-style-type:circle">Ativação: <strong>Real-time</strong> (API Entry Event) ou <strong>Scheduled</strong> (Automation Studio)</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c2-adc7-f1062b1d0559" class="bulleted-list"><li style="list-style-type:disc"><strong>Disparo sem duplicatas</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80db-97ab-f5015a41fa55" class="bulleted-list"><li style="list-style-type:circle">Use <strong>API Entry Event</strong> (recomendado para real-time):<br/>POST /interaction/v1/event<div style="display:contents" dir="auto"><p id="308795ef-9f12-80f2-91f1-f525de119352" class="">JSON</p></div><div style="display:contents" dir="auto"><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="308795ef-9f12-8073-a591-d3125e1dbb66" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">{
  &quot;ContactKey&quot;: &quot;davisvasconcellos@gmail.com&quot;,
  &quot;EventDefinitionKey&quot;: &quot;CONTACT-EVENT-abc123&quot;,
  &quot;Data&quot;: {
    &quot;EventId&quot;: &quot;evt-uuid-123456&quot;,
    &quot;EventType&quot;: &quot;inscricao_evento&quot;
  }
}</code></pre></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f0-b1d7-f2ae655e63c5" class="bulleted-list"><li style="list-style-type:circle"><strong>Idempotência</strong>: Após sucesso, atualize Processed = true na DE via PATCH ou SQL Query Activity.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8061-ada0-c2e5a641d212" class="bulleted-list"><li style="list-style-type:circle"><strong>Alternativa batch</strong>: Automation Studio com SQL Query → UPDATE EngagementEvents SET Processed = true WHERE Processed = false AND EventId IN (...) após entrada.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b2-8456-eacacdd451ff" class="bulleted-list"><li style="list-style-type:disc"><strong>Evitar duplicatas</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d8-8d67-eaad7de72934" class="bulleted-list"><li style="list-style-type:circle">EventId como chave → Journey não aceita o mesmo ContactKey + EventDefinitionKey repetido no mesmo instante (mas use Processed como guarda extra).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8060-a382-df4aa3c8e42a" class="bulleted-list"><li style="list-style-type:circle">Filtro de entrada com Processed = false garante uma única entrada.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-80a5-8fc3-f52a723abf1d" class="">4. Tratamento de OAuth2, limites de API (throttle) e retries</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80c7-8d3c-f912864dd709" class="bulleted-list"><li style="list-style-type:disc"><strong>OAuth2</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-8077-b33d-f32d093f578e" class="bulleted-list"><li style="list-style-type:circle">Connected App com Client Credentials Grant (server-to-server).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8053-b5d2-f9573c993bac" class="bulleted-list"><li style="list-style-type:circle">Escopos: data_extensions_read, data_extensions_write, journeys_execute, automation_execute.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d1-a08f-e0895068fa18" class="bulleted-list"><li style="list-style-type:circle">Armazene token + expiry; renove quando &lt; 5 min restantes.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f6-b24a-eacbf58e6620" class="bulleted-list"><li style="list-style-type:disc"><strong>Limites (throttle)</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-809c-ac00-e3a0936119e8" class="bulleted-list"><li style="list-style-type:circle">REST API: ~2500 calls/min por MID (varia por stack).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8099-acbc-f3d30686840c" class="bulleted-list"><li style="list-style-type:circle">Entry Event: ~1000/min.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-803c-af66-e5dca2b3a55f" class="bulleted-list"><li style="list-style-type:circle">Bulk: 10 jobs simultâneos.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8012-a3d5-d8235adaabaa" class="bulleted-list"><li style="list-style-type:disc"><strong>Estratégia</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d6-855a-c80a06b996c7" class="bulleted-list"><li style="list-style-type:circle">Rate limiter (ex.: token bucket ou semaforo em código).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8068-899d-d51cfd0a3335" class="bulleted-list"><li style="list-style-type:circle">Retry: exponential backoff (3–5 tentativas) em 429 (rate limit), 5xx, timeout.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80fc-b12c-d977df602719" class="bulleted-list"><li style="list-style-type:circle">Bibliotecas: tenacity (Python) ou requests com retry adapter.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><h3 id="308795ef-9f12-8070-a2a0-ee7d9b5e6e2f" class="">5. Medição e acompanhamento da integração</h3></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80db-8ca5-f39d95aa9742" class="bulleted-list"><li style="list-style-type:disc"><strong>Logs</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80f8-ab02-e981fa6c8e64" class="bulleted-list"><li style="list-style-type:circle">Log centralizado (ex.: Datadog, Splunk, SFMC Event Log Files).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80ff-999a-fc88bae9a3db" class="bulleted-list"><li style="list-style-type:circle">Registre: EventId, ContactKey, EventType, status (success/fail), latency, error message.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-804a-bbf4-c47f8c8ec8a0" class="bulleted-list"><li style="list-style-type:disc"><strong>Monitoramento</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80bd-ba63-ff6817cc48bb" class="bulleted-list"><li style="list-style-type:circle">SFMC: Query Activity + Report para contagem de Processed = false vs true.</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80d3-8699-f373630ec599" class="bulleted-list"><li style="list-style-type:circle">External: Prometheus/Grafana com métricas (sucessos/min, falhas, latency).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b4-8e5c-d301ef7bfaa6" class="bulleted-list"><li style="list-style-type:circle">Alertas: Email/Slack se ErrorCount &gt; 5 ou fila DLQ &gt; 100 eventos.</li></ul></div></li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8066-912e-e3fae98acd07" class="bulleted-list"><li style="list-style-type:disc"><strong>DLQ (Dead Letter Queue)</strong>:<div style="display:contents" dir="auto"><ul id="308795ef-9f12-80b9-87b5-c659241a0889" class="bulleted-list"><li style="list-style-type:circle">DE separada FailedEvents ou fila externa (SQS/RabbitMQ).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-806c-b677-d649736f4601" class="bulleted-list"><li style="list-style-type:circle">Automation Studio reprocessa periodicamente (ex.: a cada hora).</li></ul></div><div style="display:contents" dir="auto"><ul id="308795ef-9f12-8062-af8c-d41b69d96b3e" class="bulleted-list"><li style="list-style-type:circle">Manual: Export CSV + reenvio via Postman/Insomnia para debug.</li></ul></div></li></ul></div></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var wrapper = document.querySelector('#page-content-wrapper .container-fluid');
 
        function buildTOC() {
            var list = document.getElementById('toc-list');
            var questions = [
                { id: "308795ef-9f12-80be-bf84-f1e265e84e13", title: "1. Fluxo de Autorização OAuth 2.0" },
                { id: "308795ef-9f12-801f-b7b5-d4b74d9e9200", title: "2. Estratégias de Conexão (Token Expirando)" },
                { id: "308795ef-9f12-8045-b84c-f39a9c3467ff", title: "3. CTE Recursiva (Relacionamentos)" },
                { id: "308795ef-9f12-80d5-bd44-fb83d619a7b2", title: "4. Transações Consecutivas Altas" },
                { id: "308795ef-9f12-808e-8544-c5cfcc4a48d7", title: "5. Script Python (SQL Update)" },
                { id: "308795ef-9f12-8096-8380-c492d6c9655a", title: "6. Consumo de API (Pedidos)" },
                { id: "308795ef-9f12-80b6-bfe7-c37b0b464db4", title: "7. Normalização de Usuários (JSON)" },
                { id: "308795ef-9f12-80bc-84ac-fb489ff5282a", title: "8. Deep Key Map" },
                { id: "308795ef-9f12-802f-a5b1-f7cf8a7722e0", title: "9. Desenho Técnico (Salesforce NPSP)" },
                { id: "308795ef-9f12-8028-93d6-c95dcfddd74e", title: "10. Evento de Entrada (Marketing Cloud)" }
            ];
            if (list) {
                list.innerHTML = '';
                questions.forEach(function (q) {
                    var a = document.createElement('a');
                    a.className = 'list-group-item list-group-item-action border-0 small py-2 d-flex align-items-center';
 
                    var el = document.getElementById(q.id);
                    if (el) {
                        a.href = '#' + q.id;
                    } else {
                        a.href = '#';
                        console.warn('ID não encontrado para:', q.title);
                    }
 
                    a.innerHTML = '<i class="bi bi-file-text me-2 text-muted"></i> ' + q.title;
                    list.appendChild(a);
 
                    if (q.title.indexOf('10. Evento de Entrada') === 0) {
                        a.addEventListener('click', function (e) {
                            e.preventDefault();
                            var alvo = Array.prototype.slice.call(document.querySelectorAll('p'))
                                .find(function (p) {
                                    return p.textContent && p.textContent.trim().indexOf('Pergunta 10: Um sistema externo envia eventos de engajamento') === 0;
                                });
                            if (alvo) {
                                alvo.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } else if (el) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        });
                    }
                });
            }
        }
 
        buildTOC();
    });
    </script>
</body>
</html>
